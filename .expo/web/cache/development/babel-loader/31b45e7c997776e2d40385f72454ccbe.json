{"ast":null,"code":"\"use strict\";\n\nvar _asyncToGenerator = require(\"@babel/runtime/helpers/asyncToGenerator\");\nvar _slicedToArray = require(\"@babel/runtime/helpers/slicedToArray\");\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.TargetType = void 0;\nexports.findApplicationTargetWithDependenciesAsync = findApplicationTargetWithDependenciesAsync;\nexports.findFirstNativeTarget = findFirstNativeTarget;\nexports.findNativeTargetByName = findNativeTargetByName;\nexports.findSignableTargets = findSignableTargets;\nexports.getNativeTargets = getNativeTargets;\nexports.getXCBuildConfigurationFromPbxproj = getXCBuildConfigurationFromPbxproj;\nexports.isTargetOfType = isTargetOfType;\nfunction _BuildScheme() {\n  var data = require(\"./BuildScheme\");\n  _BuildScheme = function _BuildScheme() {\n    return data;\n  };\n  return data;\n}\nfunction _Xcodeproj() {\n  var data = require(\"./utils/Xcodeproj\");\n  _Xcodeproj = function _Xcodeproj() {\n    return data;\n  };\n  return data;\n}\nfunction _string() {\n  var data = require(\"./utils/string\");\n  _string = function _string() {\n    return data;\n  };\n  return data;\n}\nvar TargetType;\nexports.TargetType = TargetType;\n(function (TargetType) {\n  TargetType[\"APPLICATION\"] = \"com.apple.product-type.application\";\n  TargetType[\"EXTENSION\"] = \"com.apple.product-type.app-extension\";\n  TargetType[\"WATCH\"] = \"com.apple.product-type.application.watchapp\";\n  TargetType[\"APP_CLIP\"] = \"com.apple.product-type.application.on-demand-install-capable\";\n  TargetType[\"STICKER_PACK_EXTENSION\"] = \"com.apple.product-type.app-extension.messages-sticker-pack\";\n  TargetType[\"OTHER\"] = \"other\";\n})(TargetType || (exports.TargetType = TargetType = {}));\nfunction getXCBuildConfigurationFromPbxproj(project) {\n  var _ref = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n    targetName = _ref.targetName,\n    _ref$buildConfigurati = _ref.buildConfiguration,\n    buildConfiguration = _ref$buildConfigurati === void 0 ? 'Release' : _ref$buildConfigurati;\n  var _ref2 = targetName ? findNativeTargetByName(project, targetName) : findFirstNativeTarget(project),\n    _ref3 = _slicedToArray(_ref2, 2),\n    nativeTarget = _ref3[1];\n  var _ref4 = (0, _Xcodeproj().getBuildConfigurationForListIdAndName)(project, {\n      configurationListId: nativeTarget.buildConfigurationList,\n      buildConfiguration: buildConfiguration\n    }),\n    _ref5 = _slicedToArray(_ref4, 2),\n    xcBuildConfiguration = _ref5[1];\n  return xcBuildConfiguration !== null && xcBuildConfiguration !== void 0 ? xcBuildConfiguration : null;\n}\nfunction findApplicationTargetWithDependenciesAsync(_x, _x2) {\n  return _findApplicationTargetWithDependenciesAsync.apply(this, arguments);\n}\nfunction _findApplicationTargetWithDependenciesAsync() {\n  _findApplicationTargetWithDependenciesAsync = _asyncToGenerator(function* (projectRoot, scheme) {\n    var applicationTargetName = yield (0, _BuildScheme().getApplicationTargetNameForSchemeAsync)(projectRoot, scheme);\n    var project = (0, _Xcodeproj().getPbxproj)(projectRoot);\n    var _findNativeTargetByNa = findNativeTargetByName(project, applicationTargetName),\n      _findNativeTargetByNa2 = _slicedToArray(_findNativeTargetByNa, 2),\n      applicationTarget = _findNativeTargetByNa2[1];\n    var dependencies = getTargetDependencies(project, applicationTarget);\n    return {\n      name: (0, _string().trimQuotes)(applicationTarget.name),\n      type: TargetType.APPLICATION,\n      dependencies: dependencies\n    };\n  });\n  return _findApplicationTargetWithDependenciesAsync.apply(this, arguments);\n}\nfunction getTargetDependencies(project, parentTarget) {\n  if (!parentTarget.dependencies || parentTarget.dependencies.length === 0) {\n    return undefined;\n  }\n  return parentTarget.dependencies.map(function (_ref6) {\n    var value = _ref6.value;\n    var _project$getPBXGroupB = project.getPBXGroupByKeyAndType(value, 'PBXTargetDependency'),\n      targetId = _project$getPBXGroupB.target;\n    var _findNativeTargetById = findNativeTargetById(project, targetId),\n      _findNativeTargetById2 = _slicedToArray(_findNativeTargetById, 2),\n      target = _findNativeTargetById2[1];\n    var type = isTargetOfType(target, TargetType.EXTENSION) ? TargetType.EXTENSION : TargetType.OTHER;\n    return {\n      name: (0, _string().trimQuotes)(target.name),\n      type: type,\n      dependencies: getTargetDependencies(project, target)\n    };\n  });\n}\nfunction isTargetOfType(target, targetType) {\n  return (0, _string().trimQuotes)(target.productType) === targetType;\n}\nfunction getNativeTargets(project) {\n  var section = project.pbxNativeTargetSection();\n  return Object.entries(section).filter(_Xcodeproj().isNotComment);\n}\nfunction findSignableTargets(project) {\n  var targets = getNativeTargets(project);\n  var signableTargetTypes = [TargetType.APPLICATION, TargetType.APP_CLIP, TargetType.EXTENSION, TargetType.WATCH, TargetType.STICKER_PACK_EXTENSION];\n  var applicationTargets = targets.filter(function (_ref7) {\n    var _ref8 = _slicedToArray(_ref7, 2),\n      target = _ref8[1];\n    for (var targetType of signableTargetTypes) {\n      if (isTargetOfType(target, targetType)) {\n        return true;\n      }\n    }\n    return false;\n  });\n  if (applicationTargets.length === 0) {\n    throw new Error(\"Could not find any signable targets in project.pbxproj\");\n  }\n  return applicationTargets;\n}\nfunction findFirstNativeTarget(project) {\n  var targets = getNativeTargets(project);\n  var applicationTargets = targets.filter(function (_ref9) {\n    var _ref10 = _slicedToArray(_ref9, 2),\n      target = _ref10[1];\n    return isTargetOfType(target, TargetType.APPLICATION);\n  });\n  if (applicationTargets.length === 0) {\n    throw new Error(\"Could not find any application target in project.pbxproj\");\n  }\n  return applicationTargets[0];\n}\nfunction findNativeTargetByName(project, targetName) {\n  var nativeTargets = getNativeTargets(project);\n  var nativeTargetEntry = nativeTargets.find(function (_ref11) {\n    var _ref12 = _slicedToArray(_ref11, 2),\n      i = _ref12[1];\n    return (0, _string().trimQuotes)(i.name) === targetName;\n  });\n  if (!nativeTargetEntry) {\n    throw new Error(\"Could not find target '\" + targetName + \"' in project.pbxproj\");\n  }\n  return nativeTargetEntry;\n}\nfunction findNativeTargetById(project, targetId) {\n  var nativeTargets = getNativeTargets(project);\n  var nativeTargetEntry = nativeTargets.find(function (_ref13) {\n    var _ref14 = _slicedToArray(_ref13, 1),\n      key = _ref14[0];\n    return key === targetId;\n  });\n  if (!nativeTargetEntry) {\n    throw new Error(\"Could not find target with id '\" + targetId + \"' in project.pbxproj\");\n  }\n  return nativeTargetEntry;\n}","map":{"version":3,"sources":["../../src/ios/Target.ts"],"names":["TargetType","getXCBuildConfigurationFromPbxproj","project","targetName","buildConfiguration","nativeTarget","findNativeTargetByName","findFirstNativeTarget","xcBuildConfiguration","configurationListId","buildConfigurationList","findApplicationTargetWithDependenciesAsync","projectRoot","scheme","applicationTargetName","applicationTarget","dependencies","getTargetDependencies","name","type","APPLICATION","parentTarget","length","undefined","map","value","target","targetId","getPBXGroupByKeyAndType","findNativeTargetById","isTargetOfType","EXTENSION","OTHER","targetType","productType","getNativeTargets","section","pbxNativeTargetSection","Object","entries","filter","isNotComment","findSignableTargets","targets","signableTargetTypes","APP_CLIP","WATCH","STICKER_PACK_EXTENSION","applicationTargets","Error","nativeTargets","nativeTargetEntry","find","i","key"],"mappings":"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","sourcesContent":["import { PBXNativeTarget, PBXTargetDependency, XCBuildConfiguration, XcodeProject } from 'xcode';\n\nimport { getApplicationTargetNameForSchemeAsync } from './BuildScheme';\nimport {\n  getBuildConfigurationForListIdAndName,\n  getPbxproj,\n  isNotComment,\n  NativeTargetSectionEntry,\n} from './utils/Xcodeproj';\nimport { trimQuotes } from './utils/string';\n\nexport enum TargetType {\n  APPLICATION = 'com.apple.product-type.application',\n  EXTENSION = 'com.apple.product-type.app-extension',\n  WATCH = 'com.apple.product-type.application.watchapp',\n  APP_CLIP = 'com.apple.product-type.application.on-demand-install-capable',\n  STICKER_PACK_EXTENSION = 'com.apple.product-type.app-extension.messages-sticker-pack',\n  OTHER = 'other',\n}\n\nexport interface Target {\n  name: string;\n  type: TargetType;\n  dependencies?: Target[];\n}\n\nexport function getXCBuildConfigurationFromPbxproj(\n  project: XcodeProject,\n  {\n    targetName,\n    buildConfiguration = 'Release',\n  }: { targetName?: string; buildConfiguration?: string } = {}\n): XCBuildConfiguration | null {\n  const [, nativeTarget] = targetName\n    ? findNativeTargetByName(project, targetName)\n    : findFirstNativeTarget(project);\n  const [, xcBuildConfiguration] = getBuildConfigurationForListIdAndName(project, {\n    configurationListId: nativeTarget.buildConfigurationList,\n    buildConfiguration,\n  });\n  return xcBuildConfiguration ?? null;\n}\n\nexport async function findApplicationTargetWithDependenciesAsync(\n  projectRoot: string,\n  scheme: string\n): Promise<Target> {\n  const applicationTargetName = await getApplicationTargetNameForSchemeAsync(projectRoot, scheme);\n  const project = getPbxproj(projectRoot);\n  const [, applicationTarget] = findNativeTargetByName(project, applicationTargetName);\n  const dependencies = getTargetDependencies(project, applicationTarget);\n  return {\n    name: trimQuotes(applicationTarget.name),\n    type: TargetType.APPLICATION,\n    dependencies,\n  };\n}\n\nfunction getTargetDependencies(\n  project: XcodeProject,\n  parentTarget: PBXNativeTarget\n): Target[] | undefined {\n  if (!parentTarget.dependencies || parentTarget.dependencies.length === 0) {\n    return undefined;\n  }\n  return parentTarget.dependencies.map(({ value }) => {\n    const { target: targetId } = project.getPBXGroupByKeyAndType(\n      value,\n      'PBXTargetDependency'\n    ) as PBXTargetDependency;\n\n    const [, target] = findNativeTargetById(project, targetId);\n\n    const type = isTargetOfType(target, TargetType.EXTENSION)\n      ? TargetType.EXTENSION\n      : TargetType.OTHER;\n    return {\n      name: trimQuotes(target.name),\n      type,\n      dependencies: getTargetDependencies(project, target),\n    };\n  });\n}\n\nexport function isTargetOfType(target: PBXNativeTarget, targetType: TargetType): boolean {\n  return trimQuotes(target.productType) === targetType;\n}\n\nexport function getNativeTargets(project: XcodeProject): NativeTargetSectionEntry[] {\n  const section = project.pbxNativeTargetSection();\n  return Object.entries(section).filter(isNotComment);\n}\n\nexport function findSignableTargets(project: XcodeProject): NativeTargetSectionEntry[] {\n  const targets = getNativeTargets(project);\n\n  const signableTargetTypes = [\n    TargetType.APPLICATION,\n    TargetType.APP_CLIP,\n    TargetType.EXTENSION,\n    TargetType.WATCH,\n    TargetType.STICKER_PACK_EXTENSION,\n  ];\n\n  const applicationTargets = targets.filter(([, target]) => {\n    for (const targetType of signableTargetTypes) {\n      if (isTargetOfType(target, targetType)) {\n        return true;\n      }\n    }\n    return false;\n  });\n  if (applicationTargets.length === 0) {\n    throw new Error(`Could not find any signable targets in project.pbxproj`);\n  }\n  return applicationTargets;\n}\n\nexport function findFirstNativeTarget(project: XcodeProject): NativeTargetSectionEntry {\n  const targets = getNativeTargets(project);\n  const applicationTargets = targets.filter(([, target]) =>\n    isTargetOfType(target, TargetType.APPLICATION)\n  );\n  if (applicationTargets.length === 0) {\n    throw new Error(`Could not find any application target in project.pbxproj`);\n  }\n  return applicationTargets[0];\n}\n\nexport function findNativeTargetByName(\n  project: XcodeProject,\n  targetName: string\n): NativeTargetSectionEntry {\n  const nativeTargets = getNativeTargets(project);\n  const nativeTargetEntry = nativeTargets.find(([, i]) => trimQuotes(i.name) === targetName);\n  if (!nativeTargetEntry) {\n    throw new Error(`Could not find target '${targetName}' in project.pbxproj`);\n  }\n  return nativeTargetEntry;\n}\n\nfunction findNativeTargetById(project: XcodeProject, targetId: string): NativeTargetSectionEntry {\n  const nativeTargets = getNativeTargets(project);\n  const nativeTargetEntry = nativeTargets.find(([key]) => key === targetId);\n  if (!nativeTargetEntry) {\n    throw new Error(`Could not find target with id '${targetId}' in project.pbxproj`);\n  }\n  return nativeTargetEntry;\n}\n"]},"metadata":{},"sourceType":"script"}